<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        .node { fill: #3498db; stroke: #fff; stroke-width: 1.5px; cursor: pointer; }
        .link { stroke: #ccc; stroke-opacity: 0.1; transition: stroke 0.2s ease-in-out; } /* Lower opacity */
        .highlighted { stroke: black !important; stroke-width: 3px; stroke-opacity: 1 !important; } /* Fully visible when highlighted */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 6px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <svg width="1000" height="800"></svg>
    <div class="tooltip"></div>

    <script>
        d3.json("graph.json").then(function(graph) {
            const width = 1000, height = 800;

            const svg = d3.select("svg"),
                  linkScale = d3.scaleLinear().domain([0, 1]).range([1, 5]);

            const simulation = d3.forceSimulation(graph.nodes)
                .force("link", d3.forceLink(graph.links).id(d => d.id).distance(d => 400 * (1 - d.value)))
                .force("charge", d3.forceManyBody().strength(-700))
                .force("collision", d3.forceCollide().radius(20))
                .force("center", d3.forceCenter(width / 2, height / 2));

            // Append links first (so nodes render on top)
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(graph.links)
                .enter().append("line")
                .attr("class", "link")
                .attr("stroke-width", d => linkScale(d.value));

            // Create node groups
            const nodeGroups = svg.append("g")
                .attr("class", "nodes")
                .selectAll(".node-group")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node-group");

            // Append the node circle inside its group
            const nodes = nodeGroups.append("circle")
                .attr("class", "node")
                .attr("r", 8)
                .call(d3.drag()
                    .on("start", dragStarted)
                    .on("drag", dragged)
                    .on("end", dragEnded));

            const tooltip = d3.select(".tooltip");

            // Attach mouseover/mouseout only to the node circles
            nodes.on("mouseover", function(event, d) {
                tooltip.style("display", "block")
                    .html(d.id)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");

                d3.selectAll(".link")
                    .filter(link => link.source.id === d.id || link.target.id === d.id)
                    .classed("highlighted", true);
            });

            nodes.on("mouseout", function(event, d) {
                tooltip.style("display", "none");

                d3.selectAll(".link")
                    .filter(link => link.source.id === d.id || link.target.id === d.id)
                    .classed("highlighted", false);
            });

            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                nodeGroups.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            function dragStarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragEnded(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        });
    </script>
</body>
</html>
